<div class="reviews-list-container">
  @if (errorMessage && !loading) {
    <div class="error-message">
      <i class="icon">âš ï¸</i>
      <p>{{ errorMessage }}</p>
    </div>
  }

  @if (loading) {
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Caricamento recensioni...</p>
    </div>
  }

  @if (restaurantId && !loading) {
    <div class="reviews-header">
      <div class="reviews-count">
        <span class="count">{{ totalReviews }}</span>
        <span class="label">{{ totalReviews === 1 ? 'recensione' : 'recensioni' }}</span>
      </div>

      @if (hasReviews) {
        <div class="sort-controls">
          <span class="sort-label">Ordina per:</span>
          <button 
            class="sort-btn"
            [class.active]="sortBy === 'date'"
            (click)="changeSorting('date')"
          >
            ğŸ• PiÃ¹ recenti
          </button>
          <button 
            class="sort-btn"
            [class.active]="sortBy === 'votes'"
            (click)="changeSorting('votes')"
          >
            ğŸ”¥ PiÃ¹ votate
          </button>
        </div>
      }
    </div>
  }

  @if (hasReviews && !loading) {
    <div class="reviews-list">
      @for (review of displayedReviews; track review.id; let i = $index) {
        <div class="review-card">
          <div class="review-header">
            <div class="user-info">
              <div class="avatar">{{ review.username.charAt(0).toUpperCase() }}</div>
              <div class="user-details">
                <span class="username">{{ review.username }}</span>
                <span class="review-date">{{ formatDate(review.createdAt) }}</span>
              </div>
            </div>

            <div class="review-rating">
              @for (star of getRatingArray(review.rating); track $index) {
                @if (star === 1) {
                  <span class="star filled">â˜…</span>
                } @else {
                  <span class="star empty">â˜†</span>
                }
              }
              <span class="rating-number">{{ review.rating }}/5</span>
            </div>
          </div>

          <div class="review-content">
            <p 
              class="review-text"
              [class.expanded]="expandedReviewId === review.id"
            >
              {{ review.content }}
            </p>

            <!-- Pulsante "Leggi di piÃ¹" per testi lunghi -->
            @if (review.content.length > 200) {
              <button 
                class="expand-btn"
                (click)="toggleReviewExpansion(review.id)"
              >
                {{ expandedReviewId === review.id ? 'Mostra meno' : 'Leggi di piÃ¹' }}
              </button>
            }
          </div>

          <div class="review-footer">
            <div class="vote-buttons">
              <button 
                class="vote-btn upvote"
                [class.active]="review.userVote === 1"
                [disabled]="voteInProgress"
                (click)="upvoteReview(review.id, i)"
                title="Voto positivo"
              >
                <span class="icon">ğŸ‘</span>
                <span class="count">{{ review.upvotes || 0 }}</span>
              </button>

              <button 
                class="vote-btn downvote"
                [class.active]="review.userVote === -1"
                [disabled]="voteInProgress"
                (click)="downvoteReview(review.id, i)"
                title="Voto negativo"
              >
                <span class="icon">ğŸ‘</span>
                <span class="count">{{ review.downvotes || 0 }}</span>
              </button>
            </div>

            @if (isReviewAuthor(review)) {
              <div class="review-actions">
                <a 
                  [routerLink]="['/restaurants', review.restaurantId, 'reviews', review.id, 'edit']"
                  class="action-btn edit"
                  title="Modifica recensione"
                >
                  âœï¸ Modifica
                </a>
                <button 
                  class="action-btn delete"
                  (click)="deleteReview(review.id)"
                  [disabled]="loading"
                  title="Elimina recensione"
                >
                  ğŸ—‘ï¸ Elimina
                </button>
              </div>
            }
          </div>

          <!-- Badge "La tua recensione" -->
          @if (isReviewAuthor(review)) {
            <div class="owner-badge">ğŸ‘¤ La tua recensione</div>
          }
        </div>
      }
    </div>

    @if (restaurantId && totalPages > 1) {
      <div class="pagination">
        <!-- Pulsante Precedente -->
        <button 
          class="page-btn nav-btn"
          [disabled]="currentPage === 1"
          (click)="onPageChange(currentPage - 1)"
          title="Pagina precedente"
        >
          â€¹ Precedente
        </button>

        @for (page of pageNumbers; track page) {
          <button 
            class="page-btn"
            [class.active]="page === currentPage"
            (click)="onPageChange(page)"
          >
            {{ page }}
          </button>
        }

        <!-- Pulsante Successivo -->
        <button 
          class="page-btn nav-btn"
          [disabled]="currentPage === totalPages"
          (click)="onPageChange(currentPage + 1)"
          title="Pagina successiva"
        >
          Successivo â€º
        </button>
      </div>
    }
  }

  @if (!hasReviews && !loading && !errorMessage) {
    <div class="no-reviews">
      <i class="icon">ğŸ“</i>
      <h3>Nessuna recensione</h3>
      <p>
        @if (restaurantId) {
          Non ci sono ancora recensioni per questo ristorante.
        } @else {
          Non ci sono recensioni da mostrare.
        }
      </p>
    </div>
  }
</div>