<div class="profile-container">
  <div class="profile-header">
    <div class="user-avatar">
      {{ currentUser && currentUser.username ? currentUser.username.charAt(0).toUpperCase() : '?' }}
    </div>
    <div class="user-info">
      <h1>{{ currentUser?.username }}</h1>
      <p class="user-email">{{ currentUser?.email }}</p>
      <p class="member-since">Membro da {{ formatDate(currentUser?.createdAt || '') }}</p>
    </div>
  </div>
  
  <!-- Tab di navigazione -->
  <div class="tabs-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'restaurants'"
      (click)="switchTab('restaurants')">
      <i class="fas fa-utensils"></i> I Miei Ristoranti ({{ restaurantsCount }})
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'reviews'"
      (click)="switchTab('reviews')">
      <i class="fas fa-comment"></i> Le Mie Recensioni ({{ reviewsCount }})
    </button>
  </div>
  
  @if (loading) {
    <div class="loading-container">
      <app-loading-spinner></app-loading-spinner>
    </div>
  }
  
  @if (errorMessage) {
    <div class="error-message">
      {{ errorMessage }}
    </div>
  }
  
  @if (successMessage) {
    <div class="success-message">
      {{ successMessage }}
    </div>
  }
  
  <!-- Sezione d'impostazione account -->
  <div class="account-settings">
    <!-- Cambio password -->
    <section class="security-section">
      <div class="section-header">
        <h2><i class="fas fa-lock"></i> Sicurezza</h2>
        @if (!isChangingPassword) {
          <button class="btn secondary" (click)="enablePasswordChange()">
            <i class="fas fa-key"></i> Cambia Password
          </button>
        }
      </div>
      
      @if (isChangingPassword) {
        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="password-form">
          <div class="form-group">
            <label for="currentPassword">Password Attuale*</label>
            <input 
              type="password" 
              id="currentPassword" 
              formControlName="currentPassword"
              placeholder="Inserisci la password attuale">
            @if (passwordForm.get('currentPassword')?.invalid && 
                 passwordForm.get('currentPassword')?.touched) {
              <div class="validation-error">
                <span>La password attuale è obbligatoria</span>
              </div>
            }
          </div>
          
          <div class="form-group">
            <label for="newPassword">Nuova Password*</label>
            <input 
              type="password" 
              id="newPassword" 
              formControlName="newPassword"
              placeholder="Inserisci la nuova password (min 6 caratteri)">
            @if (passwordForm.get('newPassword')?.invalid && 
                 passwordForm.get('newPassword')?.touched) {
              <div class="validation-error">
                @if (passwordForm.get('newPassword')?.errors?.['required']) {
                  <span>La nuova password è obbligatoria</span>
                }
                @if (passwordForm.get('newPassword')?.errors?.['minlength']) {
                  <span>La password deve contenere almeno 6 caratteri</span>
                }
              </div>
            }
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Conferma Nuova Password*</label>
            <input 
              type="password" 
              id="confirmPassword" 
              formControlName="confirmPassword"
              placeholder="Conferma la nuova password">
            @if (passwordForm.hasError('passwordMismatch') && 
                 passwordForm.get('confirmPassword')?.touched) {
              <div class="validation-error">
                <span>Le password non corrispondono</span>
              </div>
            }
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn secondary" (click)="cancelPasswordChange()">
              <i class="fas fa-times"></i> Annulla
            </button>
            <button type="submit" class="btn primary" [disabled]="passwordForm.invalid || loading">
              <i class="fas fa-save"></i> Cambia Password
            </button>
          </div>
        </form>
      }
    </section>
    
    <!-- Eliminazione account -->
    <section class="danger-zone">
      <div class="section-header">
        <h2><i class="fas fa-exclamation-triangle"></i> Rimuovi Profilo</h2>
      </div>
      <p class="warning-text">
        Eliminando il tuo account perderai definitivamente tutti i tuoi dati, 
        inclusi i ristoranti creati e le recensioni pubblicate. 
        Una volta eliminato l'account, non c'è modo di tornare indietro. Sei sicuro?
      </p>
      <button class="btn danger" (click)="deleteAccount()">
        <i class="fas fa-trash-alt"></i> Elimina Account
      </button>
    </section>
  </div>
  
  <!-- Popup per "Nessuna Recensione" -->
  @if (showNoReviewsPopup) {
    <div class="popup-overlay">
      <div class="popup-content">
        <button class="close-button" (click)="closeNoReviewsPopup()">&times;</button>
        <div class="popup-icon">✍️</div>
        <h3>Non hai ancora scritto recensioni</h3>
        <p>Che ne dici di iniziare? Esplora i ristoranti e condividi la tua esperienza con la community!</p>
        <a [routerLink]="['/restaurants']" class="btn primary" (click)="closeNoReviewsPopup()">
          <i class="fas fa-utensils"></i> Esplora Ristoranti
        </a>
      </div>
    </div>
  }
  
  <!-- Tab: I Miei Ristoranti -->
  @if (activeTab === 'restaurants' && !loading) {
    <div class="tab-content">
      @if (userRestaurants.length === 0) {
        <div class="empty-state">
          <i class="fas fa-utensils"></i>
          <h3>Nessun ristorante creato</h3>
          <p>Non hai ancora creato nessun ristorante. Inizia ora!</p>
          <a [routerLink]="['/restaurants/new']" class="btn primary">
            <i class="fas fa-plus-circle"></i> Crea Ristorante
          </a>
        </div>
      }
      
      @if (userRestaurants.length > 0) {
        <div class="restaurants-grid">
          @for (restaurant of userRestaurants; track restaurant.id) {
            <div class="restaurant-card">
              <a [routerLink]="['/restaurants', restaurant.id]" class="restaurant-link">
                <div class="restaurant-image">
                  <img [src]="restaurant.imageUrl || 'assets/images/restaurant-placeholder.jpg'" [alt]="restaurant.name">
                </div>
                <div class="restaurant-info">
                  <h3>{{ restaurant.name }}</h3>
                  <p>{{ restaurant.description | slice:0:100 }}...</p>
                  <div class="restaurant-meta">
                    @if (restaurant.averageRating) {
                      <span class="rating">
                        <i class="fas fa-star"></i> {{ restaurant.averageRating | number:'1.1-1' }}
                      </span>
                    }
                    <span class="reviews">
                      <i class="fas fa-comment"></i> {{ restaurant.reviewsCount || 0 }}
                    </span>
                  </div>
                </div>
              </a>
            </div>
          }
        </div>
      }
    </div>
  }
  
  <!-- Tab: Le Mie Recensioni -->
  @if (activeTab === 'reviews' && !loading) {
    <div class="tab-content">
      @if (userReviews.length === 0) {
        <div class="empty-state flashcard">
          <div class="flashcard-icon">✍️</div>
          <h3>Scrivi una recensione a un ristorante</h3>
          <p>Inizia a condividere le tue esperienze! Esplora i ristoranti e scrivi la tua prima recensione.</p>
          <a [routerLink]="['/restaurants']" class="btn primary">
            <i class="fas fa-utensils"></i> Esplora Ristoranti
          </a>
        </div>
      }
      
      @if (userReviews.length > 0) {
        <div class="reviews-list">
          @for (review of userReviews; track review.id) {
            <div class="review-card">
              <div class="review-header">
                <h3>
                  <a [routerLink]="['/restaurants', review.restaurantId]">
                    {{ review.restaurantName }}
                  </a>
                </h3>
                <div class="rating">
                  @for (star of [].constructor(review.rating); track $index) {
                    <i class="fas fa-star"></i>
                  }
                </div>
              </div>
              <p class="review-content">{{ review.content }}</p>
              <div class="review-footer">
                <span class="date">{{ formatDate(review.createdAt) }}</span>
                <div class="review-actions">
                  <a [routerLink]="['/reviews', review.id, 'edit']" class="btn small secondary">
                    <i class="fas fa-edit"></i> Modifica
                  </a>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
